# We use this module for opperations that will be commonly used in different pipelineModules




from astropy.io import fits
import numpy as np
from numba import njit
from pymongo import MongoClient

client = MongoClient()
db = client["databaseMARVEL"]




def saveFigure(figure):
    ...


def getImages(paths):
    return np.array([getImage(path) for path in paths])



def getImage(path):
    hdul = fits.open(path)
    return hdul[0].data

@njit()
def getGain(path):
    # TODO: This should be read from the fits file [e/ADU]
    return 9.4

@njit()
def getExposureTime(path):
    # TODO: This should be read from the fits file [s]
    return 5

@njit()
def getDarkRate(path):
    # TODO: This should be read from the fits file [e/pix/s]
    return 0.1




def addToDataBase(dict, overWrite=False):
    # We should have proper error catching for:
    # 1. We want to add somthing that already exist
    # 2. image is not in the dictornary
    # 3. Check that dict is in the right format 

    images     = {"Master Dark Image": "DarkImages", "Master Bias Image": "BiasImages", "Master Flat Image": "FlatImages", "Calibrated Science Image" : "ScienceImages"}
    typeImage  = dict["type"]
    collection = db[images[typeImage]]

    isInCollection = np.all([x == dict for x in collection.find({"_id" : dict["_id"]})])

    if not isInCollection:
        collection.inster_one(dict)

    elif overWrite:
        collection.delete_many({"_id": dict["_id"]})
        collection.insert_one(dict)
    else:
        print("Document is already in database")
    
    
        
def getPositionsOfOrders():
    p = {}
    positions = [ 276.47034757,  293.29151457,  310.02540273,  326.69533521,  343.33412994,
                  544.81733451,  561.52993913,  578.16816779,  594.77397072,  611.34838329,
                  805.89583395,  822.52396273,  839.08604478,  855.64288321,  872.15142763,
                  1060.03078413, 1076.57288292, 1093.10222727, 1109.57997859, 1126.06574561,
                  1307.49950152, 1323.98236364, 1340.45814225, 1356.88917131, 1373.33886427,
                  1548.57285103, 1565.00483684, 1581.43936976, 1597.82852469, 1614.2276996,
                  1783.50697697, 1799.88069926, 1816.27169165, 1832.62626626, 1848.97029067,
                  2012.4966333,  2028.86548177, 2045.19293021, 2061.49400573, 2077.84073522,
                  2235.81530904, 2252.09805389, 2268.42266958, 2284.69600658, 2300.96612213,
                  2453.63432501, 2469.89739046, 2486.13183756, 2502.35643693, 2518.64524964,
                  2666.12911951, 2682.34012918, 2698.55284353, 2714.77374492, 2731.00008524,
                  2873.48056255, 2889.69724295, 2905.8721813,  2922.03283324, 2938.22340887,
                  3075.92275674, 3092.05623548, 3108.18211758, 3124.33547446, 3140.5228562,
                  3273.55744873, 3289.65985127, 3305.74587484, 3321.84634763, 3337.97406045,
                  3466.51604359, 3482.60660853, 3498.68261805, 3514.76529123, 3530.86948563,
                  3655.01399839, 3671.0756758,  3687.10863157, 3703.16053125, 3719.23410192,
                  3839.18975558, 3855.18577666, 3871.18428103, 3887.19504057, 3903.2303084,
                  4019.15206183, 4035.11446118, 4051.07855914, 4067.05520655, 4083.0631696,
                  4194.99493977, 4210.90911916, 4226.81361559, 4242.76181204, 4258.74556228,
                  4366.85265715, 4382.74579881, 4398.65075966, 4414.56654042, 4430.52156323,
                  4534.87393071, 4550.73673709, 4566.61157353, 4582.49843329, 4598.42311403,
                  4699.18752196, 4714.98358156, 4730.80033616, 4746.66528973, 4762.56499905,
                  4859.78583132, 4875.59348888, 4891.40140799, 4907.22761904, 4923.09825375,
                  5016.93459551, 5032.64549592, 5048.42244384, 5064.23014409, 5080.07679083,
                  5170.58206666, 5186.28637915, 5202.03602523, 5217.80440809, 5233.6164422,
                  5320.87026978, 5336.60357033, 5352.29338351, 5367.99415323, 5383.802532,
                  5467.93062264, 5483.6007161,  5499.29484865, 5514.9938392,  5530.71448992,
                  5611.8116421,  5627.45238863, 5643.10804203, 5658.79428705, 5674.51066553,
                  5752.57157529, 5768.24083532, 5783.83436648, 5799.5038061,  5815.20186385,
                  5890.31257984, 5905.99104177, 5921.57994397, 5937.19628705, 5952.87176223,
                  6025.1655429,  6040.78130841, 6056.39616071, 6071.93147197, 6087.60220031,
                  6157.13141789, 6172.75301585, 6188.29018591, 6203.88335827, 6219.43799964,
                  6286.32141102, 6301.85536944, 6317.44826399, 6332.98769397, 6348.56123187,
                  6412.77928345, 6428.31489145, 6443.86678921, 6459.38586516, 6474.93177754,
                  6536.55262145, 6552.13287731, 6567.59370386, 6583.14381099, 6598.61357654,
                  6657.78972455, 6673.34019849, 6688.79435223, 6704.30936524, 6719.77348689,
                  6776.52748189, 6792.00255091, 6807.48250133, 6822.93459153, 6838.39781376,
                  6892.7750038,  6908.23332428, 6923.67533133, 6939.12268669, 6954.51858596,
                  7006.61457325, 7022.07888762, 7037.48679237, 7052.87933593, 7068.32488768,
                  7118.13196512, 7133.57385512, 7148.93637816, 7164.36320259, 7179.73217468,
                  7227.38126648, 7242.79661041, 7258.13947084, 7273.53196985, 7288.88080687,
                  7334.39581257, 7349.80247333, 7365.14435328, 7380.4447697,  7395.81451559,
                  7439.30037827, 7454.60445026, 7469.97195087, 7485.28355235, 7500.55852004,
                  7542.07353484, 7557.39063506, 7572.67393223, 7587.9620371,  7603.27723802,
                  7642.79516329, 7658.06814181, 7673.39479634, 7688.64171006, 7703.89948757,
                  7741.58635502, 7756.83924692, 7772.06161255, 7787.32189989, 7802.61517515,
                  7838.40913602, 7853.66721849, 7868.88051201, 7884.10069845, 7899.34726358,
                  7933.36761135, 7948.61201168, 7963.82911585, 7979.06078845, 7994.28182282,
                  8026.54161756, 8041.78600585, 8056.98730925, 8072.1994811,  8087.4049997,
                  8118.05818416, 8133.21278398, 8148.39855214, 8163.58961481, 8178.83446714,
                  8207.80506012, 8223.0082302,  8238.21146775, 8253.38975396, 8268.55656278,
                  8296.03337131, 8311.23239918, 8326.40316335, 8341.56359151, 8356.70845558,
                  8382.72735235, 8397.87742691, 8413.09251235, 8428.25387445, 8443.38975797,
                  8468.01982291, 8483.20877179, 8498.35094508, 8513.48292909, 8528.59482817,
                  8551.94211933, 8567.09489802, 8582.24583715, 8597.3696133,  8612.4598388,
                  8634.66100577, 8649.77149577, 8664.86860776, 8679.95026871, 8695.01702119,
                  8716.1257905,  8731.26146683, 8746.36431981, 8761.43444258, 8776.51094225,
                  8796.6188383,  8811.70113776, 8826.7575624,  8841.81430576, 8856.88565171,
                  8876.06831061, 8891.1168787,  8906.16325439, 8921.23341483, 8936.33660725,
                  8954.74859894, 8969.79446379, 8984.85981612, 8999.91775128, 9014.97026853,
                  9032.724891,   9047.78518792, 9062.84472106, 9077.89539614, 9092.92734815,
                  9110.16435628, 9125.21649696, 9140.2554798,  9155.28750395, 9170.29639876,
                  9187.29014879, 9202.32578198, 9217.34812559, 9232.37145401, 9247.35445645,
                  9264.2826628,  9279.29955006, 9294.30297299, 9309.29109291, 9324.27277666,
                  9341.33600799, 9356.32889281, 9371.31776225, 9386.29471818, 9401.26896406,
                  9418.76224184, 9433.74115057, 9448.72054669, 9463.68950458, 9478.64371499]
    
    #positions = [271.06906306345707, 288.6914358908522, 307.9282027760769, 325.3463919968236, 342.3464864319031, 547.314074582757, 562.8290135826136, 579.9822117677322, 595.3644568319994, 611.068807943924, 807.8008008628187, 824.4555800922623, 840.9372942853912, 856.9131503248539, 872.1700897753782, 1061.0042287342296, 1078.4449314405574, 1093.718081721024, 1110.2450967792652, 1125.4771134473276, 1308.7595967644775, 1324.6200125003224, 1339.8337046085621, 1356.9458747379126, 1373.380480387468, 1549.103422396806, 1566.2298851121368, 1581.4494100499778, 1596.6937653921773, 1611.9115669044177, 1784.1539543279046, 1800.997217189317, 1816.3152647142056, 1831.5362374653555, 1848.9705899907426, 2014.6933830716457, 2030.0728730479514, 2046.4664682591142, 2061.7698427772098, 2077.9754057091454, 2236.555890363361, 2252.0191553361524, 2268.5015462277697, 2283.9051174299443, 2299.6938396673618, 2453.842351810493, 2469.5171962633635, 2487.3923042716224, 2502.927638997711, 2521.1055000775295, 2666.0341551803094, 2682.358889396776, 2699.3354036168203, 2715.158953865929, 2731.026160244147, 2874.156653555941, 2890.0389153192077, 2905.860776163449, 2921.6754982597877, 2938.3567617312888, 3075.8528264465062, 3092.2027512007817, 3108.418027830255, 3124.34329206456, 3140.9825013623085, 3273.5327578581973, 3289.6658428935607, 3305.799558863772, 3321.9072511304207, 3337.9503415710296, 3466.5209087279013, 3482.610376219783, 3498.6879972378497, 3514.768257567991, 3530.868361939801, 3655.017473722253, 3671.0788214843064, 3687.1120118183953, 3703.1619283465448, 3719.232397789378, 3839.192941774442, 3855.1883371937906, 3871.1869071467436, 3887.1973987359315, 3903.2301491121384, 4019.1519419805627, 4035.1153680928337, 4051.079184214144, 4067.056489757279, 4083.062551568474, 4194.99419392376, 4210.90915617388, 4226.814656876538, 4242.762470239484, 4258.745699343271, 4366.853055824926, 4382.7461934062085, 4398.650829386187, 4414.566669072016, 4430.521351116687, 4534.873991924154, 4550.736737092808, 4566.6115735259855, 4582.498433286968, 4598.423114029814, 4699.187521960876, 4714.983581555685, 4730.800336162694, 4746.665289733164, 4762.564882044768, 4859.785831317976, 4875.59348887922, 4891.401407988361, 4907.227619044957, 4923.098253748274, 5016.934595511916, 5032.645495921555, 5048.422443837458, 5064.230144093777, 5080.076790834697, 5170.582066659915, 5186.286379153562, 5202.036025229132, 5217.80440809377, 5233.616442203771, 5320.870269775624, 5336.603570326887, 5352.293383505666, 5367.994153231152, 5383.80253199592, 5467.930622639568, 5483.600716098891, 5499.294848648281, 5514.993839199334, 5530.714489918128, 5611.811642101626, 5627.4523886322495, 5643.108042027384, 5658.794287050615, 5674.510665532998, 5752.571575286661, 5768.24083531922, 5783.834366484145, 5799.503806098134, 5815.201863852379, 5890.312579840052, 5905.991041767313, 5921.579943966299, 5937.196287051937, 5952.871762229375, 6025.165542896891, 6040.781308411779, 6056.396160707039, 6071.931471969399, 6087.6022003083035, 6157.131417892357, 6172.753015853686, 6188.290185907212, 6203.883358268223, 6219.43799964465, 6286.3214110195995, 6301.855369444421, 6317.448263987684, 6332.987693972012, 6348.561231866541, 6412.779283450121, 6428.314891448716, 6443.866789213211, 6459.385865161065, 6474.931777543944, 6536.552621454922, 6552.132877307703, 6567.593703858527, 6583.143810993466, 6598.613576537286, 6657.7897245469685, 6673.340198486618, 6688.794352231675, 6704.309365240583, 6719.773486891868, 6776.527481892518, 6792.0025509102325, 6807.482501330185, 6822.934591525495, 6838.397813757185, 6892.775003795853, 6908.233324280357, 6923.675331333836, 6939.122686690748, 6954.518585958604, 7006.614573250723, 7022.078887620335, 7037.486792373366, 7052.879335930457, 7068.324887682187, 7118.131965116888, 7133.573855120987, 7148.936378160937, 7164.363202585042, 7179.732174679188, 7227.381266477868, 7242.7966104127045, 7258.1394708427415, 7273.531969854639, 7288.880806873267, 7334.395812571607, 7349.802473333048, 7365.144353278717, 7380.444769701858, 7395.814515588676, 7439.300378273342, 7454.604450260224, 7469.971950870725, 7485.283552346388, 7500.55852003687, 7542.073534836481, 7557.3906350589, 7572.673932231255, 7587.96203709525, 7603.277238016943, 7642.795163289197, 7658.068141805952, 7673.394796342577, 7688.64171005637, 7703.899487569957, 7741.586355015313, 7756.839246919943, 7772.061612552199, 7787.3218998910115, 7802.615175154072, 7838.409136018597, 7853.667218493303, 7868.880512013852, 7884.100698449969, 7899.347263578217, 7933.367611350944, 7948.612011684528, 7963.829115850828, 7979.060788448144, 7994.281822817918, 8026.54161755582, 8041.786005847731, 8056.987309252079, 8072.199481104393, 8087.404999699469, 8118.058184156789, 8133.212783980461, 8148.3985521442155, 8163.58961481124, 8178.834467139528, 8207.805060117727, 8223.008230196276, 8238.211467746192, 8253.389753958798, 8268.556562783597, 8296.033371308811, 8311.232399182496, 8326.403163348, 8341.56359151297, 8356.708455581238, 8382.727352345066, 8397.877426913908, 8413.092512347752, 8428.253874452057, 8443.38975796871, 8468.019822914323, 8483.208771789337, 8498.350945075668, 8513.482929091588, 8528.594828172687, 8551.942119329446, 8567.094898017323, 8582.24583714721, 8597.369613304963, 8612.459838802271, 8634.66100576584, 8649.771495774745, 8664.868607763761, 8679.95026871189, 8695.017021187829, 8716.125790498545, 8731.261466830882, 8746.364319805589, 8761.434442581609, 8776.510942248795, 8796.618838303975, 8811.701137764616, 8826.75756240361, 8841.814305755888, 8856.885651712973, 8876.068310611354, 8891.11687870224, 8906.16325438683, 8921.233414829594, 8936.33660725487, 8954.748598937564, 8969.794463790973, 8984.859816122917, 8999.917751280045, 9014.97026852886, 9032.724890995636, 9047.785187923402, 9062.844721056887, 9077.895396142767, 9092.927348147017, 9110.16435627725, 9125.216496961148, 9140.25547979524, 9155.287503947779, 9170.296398763105, 9187.29014879065, 9202.325781983662, 9217.348125588736, 9232.371454014963, 9247.354456454861, 9264.282662800413, 9279.29955005841, 9294.302972991132, 9309.29109290893, 9324.272776657666]


    fibers = []
    orders = []
    for i in np.arange(np.size(positions)):
        order = int((i)/5)+1
        fiber = int((i+1)%5)
        if (fiber == 0):
            fiber=5

        fibers.append(fiber)
        orders.append(order)

    p = np.array([fibers, orders, positions])
    
    return p



if __name__ == "__main__":
    path = "/lhome/driess/MARVEL/MARVELpipe/Data/RawData/CalibrationImages/Bias/bias_0001.fits"
    print(getImage(path))
